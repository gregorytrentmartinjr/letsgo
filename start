#!/bin/bash

# Update system and install essential packages
sudo pacman -Syu --noconfirm
sudo pacman -S --noconfirm base-devel git

# Clone yay (AUR helper) into ~/.cache and build it
git clone https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD ~/.cache/yay
cd ~/.cache/yay
makepkg -si --noconfirm

# Install limine and add custom background color
yay -S --noconfirm limine
sudo sh -c "echo -e '\
term_palette: 303446;e78284;a6d189;e5c890;8caaee;f4b8e4;81c8be;c6d0f5\n\
term_palette_bright: 626880;e78284;a6d189;e5c890;8caaee;f4b8e4;81c8be;c6d0f5\n\
term_background: 303446\n\
term_foreground: c6d0f5\n\
term_background_bright: 626880\n\
term_foreground_bright: c6d0f5\n' | cat - /boot/limine/limine.conf > /tmp/limine.conf && sudo mv /tmp/limine.conf /boot/limine/limine.conf"

# Install plymouth theme and rebuild the kernel
sudo pacman -S --noconfirm plymouth
yay -S --noconfirm plymouth-theme-cuts-alt-git
sudo sed -i '/^HOOKS=/ s/\(base udev\)/\1 plymouth/' /etc/mkinitcpio.conf
sudo sed -i '/^ *cmdline:/ s/$/ quiet splash plymouth.delay=5/' /boot/limine/limine.conf
sudo mkinitcpio -P

# Install sddm and necessary Qt5 dependencies for Pixie SDDM theme
sudo pacman -S --needed --noconfirm sddm qt5-graphicaleffects qt5-quickcontrols2 qt5-svg

# Install Pixie SDDM theme
git clone https://github.com/xCaptaiN09/pixie-sddm.git ~/.cache/pixie-sddm
cd ~/.cache/pixie-sddm
sudo ./install.sh
sudo systemctl enable sddm  # Enable SDDM to start on boot.

# Install Hyprland compositor
sudo pacman -S --noconfirm hyprland

# Clone Hyprland configuration files
git clone -b custom https://github.com/gregorytrentmartinjr/dots-hyprland ~/.cache/dots-hyprland

# Copy background image if present
if [ -f ~/.cache/letsgo/background.jpg ]; then
    sudo cp ~/.cache/letsgo/background.jpg /usr/share/sddm/themes/pixie/assets/background.jpg
else
    echo "Background image not found!"  # Print a message if the image is not found.
fi

# This installs topgrade (for upgrading packages), mpvpaper (wallpaper manager), and fastfetch (system info tool).
yay -S --noconfirm topgrade mpvpaper fastfetch

# Install graphics-related packages
sudo pacman -S --noconfirm mesa vulkan-radeon libva libva-mesa-driver libva-utils libxcrypt-compat

# Install specific packages from Arch Linux archive
sudo pacman -U --noconfirm \
https://archive.archlinux.org/packages/h/hsa-rocr/hsa-rocr-7.1.1-2-x86_64.pkg.tar.zst \
https://archive.archlinux.org/packages/s/spirv-llvm-translator/spirv-llvm-translator-21.1.3-1-x86_64.pkg.tar.zst \
https://archive.archlinux.org/packages/r/rocminfo/rocminfo-7.1.1-1-x86_64.pkg.tar.zst \
https://archive.archlinux.org/packages/r/rocm-core/rocm-core-7.1.1-1-x86_64.pkg.tar.zst \
https://archive.archlinux.org/packages/r/rocm-device-libs/rocm-device-libs-2%3A7.1.1-2-x86_64.pkg.tar.zst \
https://archive.archlinux.org/packages/r/rocm-opencl-runtime/rocm-opencl-runtime-7.1.1-1-x86_64.pkg.tar.zst \
https://archive.archlinux.org/packages/r/rocm-llvm/rocm-llvm-2%3A7.1.1-2-x86_64.pkg.tar.zst

# Setup custom Hyprland configuration
cd ~/.cache/dots-hyprland
./setup install

# Update user directories and MIME types
xdg-mime default org.gnome.Nautilus.desktop inode/directory
xdg-user-dirs-update

# This group of commands sets up Flatpak package management and adds the Flathub repository for accessing Flatpak apps.
sudo pacman -S --noconfirm flatpak
flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
sudo pacman -S --noconfirm gnome-software

# Run topgrade to upgrade everything
topgrade