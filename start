#!/usr/bin/env bash
set -euo pipefail

# Create cache directory
CACHE="$HOME/.cache/setup"
mkdir -p "$CACHE"

# Optimize pacman configuration
sudo sed -i 's/^#Color/Color/' /etc/pacman.conf
sudo sed -i 's/^#ParallelDownloads.*/ParallelDownloads = 15/' /etc/pacman.conf
if ! grep -q "ILoveCandy" /etc/pacman.conf; then
  sudo sed -i '/^Color/a ILoveCandy' /etc/pacman.conf
fi

# Optimize makepkg for all CPU cores
CORES=$(nproc)
if grep -q "^MAKEFLAGS=" /etc/makepkg.conf; then
  sudo sed -i "s/^MAKEFLAGS=.*/MAKEFLAGS=\"-j$CORES\"/" /etc/makepkg.conf
else
  sudo sed -i "s/^#MAKEFLAGS=.*/MAKEFLAGS=\"-j$CORES\"/" /etc/makepkg.conf
fi

if grep -q "^COMPRESSXZ=" /etc/makepkg.conf; then
  sudo sed -i "s|^COMPRESSXZ=.*|COMPRESSXZ=(xz -c -T $CORES -z -)|" /etc/makepkg.conf
else
  echo "COMPRESSXZ=(xz -c -T $CORES -z -)" | sudo tee -a /etc/makepkg.conf > /dev/null
fi

# Pacman flags
PACMAN_FLAGS="--needed --noconfirm"

# Update system
sudo pacman -Syu $PACMAN_FLAGS

sudo pacman -S $PACMAN_FLAGS hyprland base-devel

# Install Pixie SDDM theme
git clone https://github.com/xCaptaiN09/pixie-sddm.git "$CACHE/pixie-sddm"
cd "$CACHE/pixie-sddm"
sudo ./install.sh
sudo cp "$HOME/.cache/letsgo/background.jpg" /usr/share/sddm/themes/pixie/assets/background.jpg

# Enable SDDM service
sudo systemctl enable sddm

# Install Hyprland config
git clone -b custom https://github.com/gregorytrentmartinjr/dots-hyprland "$CACHE/dots-hyprland"
cd "$CACHE/dots-hyprland"
echo -e "\n\n\n\nn\n" | ./setup install

sudo pacman -S $PACMAN_FLAGS "${CORE_PKGS[@]}"

# Install core packages
CORE_PKGS=(
  less clinfo
  qt5-graphicaleffects qt5-quickcontrols2 qt5-svg
  gnome-software appstream appstream-glib flatpak
  mesa vulkan-radeon libva libva-mesa-driver
  lib32-vulkan-radeon libva-utils libxcrypt-compat
  firefox
  jdk-openjdk
)

# Install AUR packages
yay -S $PACMAN_FLAGS \
  topgrade mpvpaper fastfetch \
  steam obs-studio obs-vkcapture lib32-obs-vkcapture \
  visual-studio-code-bin github-desktop-bin

# Remove Google Chrome
yay -Rdd --noconfirm google-chrome

# Configure XDG and Flatpak
xdg-mime default org.gnome.Nautilus.desktop inode/directory
xdg-user-dirs-update
flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
sudo appstreamcli refresh --force

# Install ROCm packages
ROCM_URLS=(
  https://archive.archlinux.org/packages/h/hsa-rocr/hsa-rocr-7.1.1-2-x86_64.pkg.tar.zst
  https://archive.archlinux.org/packages/s/spirv-llvm-translator/spirv-llvm-translator-21.1.3-1-x86_64.pkg.tar.zst
  https://archive.archlinux.org/packages/r/rocminfo/rocminfo-7.1.1-1-x86_64.pkg.tar.zst
  https://archive.archlinux.org/packages/r/rocm-core/rocm-core-7.1.1-1-x86_64.pkg.tar.zst
  https://archive.archlinux.org/packages/r/rocm-device-libs/rocm-device-libs-2%3A7.1.1-2-x86_64.pkg.tar.zst
  https://archive.archlinux.org/packages/r/rocm-opencl-runtime/rocm-opencl-runtime-7.1.1-1-x86_64.pkg.tar.zst
  https://archive.archlinux.org/packages/r/rocm-llvm/rocm-llvm-2%3A7.1.1-2-x86_64.pkg.tar.zst
)

sudo pacman -U --noconfirm "${ROCM_URLS[@]}"

# Download DaVinci Resolve
wget -O "$HOME/Downloads/DaVinci_Resolve.zip" \
  "https://swr.cloud.blackmagicdesign.com/DaVinciResolve/v20.3.2/DaVinci_Resolve_Studio_20.3.2_Linux.zip"

# Install Resolve VAAPI plugin
sudo mkdir -p /opt/resolve/IOPlugins
sudo unzip -o \
  "$HOME/.cache/letsgo/vaapi_encoder.dvcp.bundle.zip" \
  -d /opt/resolve/IOPlugins/

# Cleanup cache and package files
rm -rf "$CACHE" "$HOME/.cache/letsgo"
yay -Scc --noconfirm