#!/bin/bash

# Set cache directory
export CACHE="$HOME/.cache/setup"
mkdir -p "$CACHE"

# Optimize pacman configuration
sudo sed -i 's/^#Color/Color/' /etc/pacman.conf
sudo sed -i 's/^#ParallelDownloads.*/ParallelDownloads = 15/' /etc/pacman.conf
if ! grep -q "ILoveCandy" /etc/pacman.conf; then
  sudo sed -i '/^Color/a ILoveCandy' /etc/pacman.conf
fi

# Optimize makepkg for all CPU cores
CORES=$(nproc)
if grep -q "^MAKEFLAGS=" /etc/makepkg.conf; then
  sudo sed -i "s/^MAKEFLAGS=.*/MAKEFLAGS=\"-j$CORES\"/" /etc/makepkg.conf
else
  sudo sed -i "s/^#MAKEFLAGS=.*/MAKEFLAGS=\"-j$CORES\"/" /etc/makepkg.conf
fi

if grep -q "^COMPRESSXZ=" /etc/makepkg.conf; then
  sudo sed -i "s|^COMPRESSXZ=.*|COMPRESSXZ=(xz -c -T $CORES -z -)|" /etc/makepkg.conf
else
  echo "COMPRESSXZ=(xz -c -T $CORES -z -)" | sudo tee -a /etc/makepkg.conf > /dev/null
fi

# Update system and install essential packages
sudo pacman -Syu --noconfirm
sudo pacman -S --noconfirm base-devel git

# Setup custom Hyprland configuration
git clone -b custom https://github.com/gregorytrentmartinjr/dots-hyprland "$CACHE/dots-hyprland"
cd "$CACHE/dots-hyprland"
echo -e "\n\n\n\nn\n" | ./setup install

# Quiet verbose text, install sddm, and install Pixie SDDM theme
sudo sed -i '/^options / s/$/ quiet loglevel=3 systemd.show_status=auto rd.udev.log_level=3/' /boot/loader/entries/*linux.conf
sudo pacman -S --needed --noconfirm sddm
git clone https://github.com/xCaptaiN09/pixie-sddm.git "$CACHE/pixie-sddm"
cd "$CACHE/pixie-sddm"
sudo ./install.sh
sudo cp "$HOME/.cache/letsgo/background.jpg" /usr/share/sddm/themes/pixie/assets/background.jpg
sudo systemctl enable sddm  # Enable SDDM to start on boot.

# Update user directories and MIME types
xdg-mime default org.gnome.Nautilus.desktop inode/directory
xdg-user-dirs-update

# Set up GNOME Software with Flatpak and AppStream
flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
sudo appstreamcli refresh --force

# Install graphics-related packages
sudo pacman -S --needed --noconfirm mesa vulkan-radeon libva libva-mesa-driver lib32-vulkan-radeon libva-utils libxcrypt-compat

# MY OOB Setup
sudo cp "$HOME/.cache/letsgo/monitors.conf" "$HOME/.config/hypr/monitors.conf"
yay -Rdd --sudoloop --noconfirm google-chrome
sudo pacman -S --needed --noconfirm firefox
yay -S --needed --sudoloop --noconfirm steam obs-studio obs-vkcapture lib32-obs-vkcapture visual-studio-code-bin github-desktop-bin

# Install openjdk for Davinci Resolve
sudo pacman -S --needed --noconfirm jdk-openjdk

# Install ROCm packages (simplified, same as before)
sudo pacman -U --needed --noconfirm \
https://archive.archlinux.org/packages/h/hsa-rocr/hsa-rocr-7.1.1-2-x86_64.pkg.tar.zst \
https://archive.archlinux.org/packages/s/spirv-llvm-translator/spirv-llvm-translator-21.1.3-1-x86_64.pkg.tar.zst \
https://archive.archlinux.org/packages/r/rocminfo/rocminfo-7.1.1-1-x86_64.pkg.tar.zst \
https://archive.archlinux.org/packages/r/rocm-core/rocm-core-7.1.1-1-x86_64.pkg.tar.zst \
https://archive.archlinux.org/packages/r/rocm-device-libs/rocm-device-libs-2%3A7.1.1-2-x86_64.pkg.tar.zst \
https://archive.archlinux.org/packages/r/rocm-opencl-runtime/rocm-opencl-runtime-7.1.1-1-x86_64.pkg.tar.zst \
https://archive.archlinux.org/packages/r/rocm-llvm/rocm-llvm-2%3A7.1.1-2-x86_64.pkg.tar.zst

# Download Davinci Resolve
wget -O $HOME/Downloads/DaVinci_Resolve_Studio_20.3.2_Linux.zip 'https://swr.cloud.blackmagicdesign.com/DaVinciResolve/v20.3.2/DaVinci_Resolve_Studio_20.3.2_Linux.zip?verify=1771610103-TbsyTsqBH3DXjU2IQB6pKY8DlFARYtqsl1xfxtvHMVQ%3D'

# Install Davinci Resolve VAAPI plugin
sudo mkdir -p /opt/resolve/IOPlugins
sudo unzip -o "$HOME/.cache/letsgo/vaapi_encoder.dvcp.bundle.zip" -d /opt/resolve/IOPlugins/
#cd /opt/resolve/libs && sudo mkdir disabled-libraries && sudo mv libglib* libgio* libgmodule* disabled-libraries

sudo rm -rf "$CACHE"
sudo rm -rf"$HOME/.cache/letsgo/"
yay -Scc --noconfirm
